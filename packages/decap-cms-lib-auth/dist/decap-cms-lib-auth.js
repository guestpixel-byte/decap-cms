!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("immutable"),require("uuid")):"function"==typeof define&&define.amd?define("DecapCmsLibAuth",["immutable","uuid"],t):"object"==typeof exports?exports.DecapCmsLibAuth=t(require("immutable"),require("uuid")):e.DecapCmsLibAuth=t(e.DecapCmsDefaultExports.Immutable,e.DecapCmsDefaultExports.UUId)}(window,((e,t)=>(()=>{var r={650:(e,t,r)=>{var n=r(942).Symbol;e.exports=n},111:e=>{e.exports=function(e,t){for(var r=-1,n=null==e?0:e.length,o=Array(n);++r<n;)o[r]=t(e[r],r,e);return o}},837:e=>{e.exports=function(e){return e.split("")}},250:e=>{e.exports=function(e,t,r,n){for(var o=e.length,i=r+(n?1:-1);n?i--:++i<o;)if(t(e[i],i,e))return i;return-1}},379:(e,t,r)=>{var n=r(650),o=r(870),i=r(5),a=n?n.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":a&&a in Object(e)?o(e):i(e)}},478:(e,t,r)=>{var n=r(250),o=r(454),i=r(706);e.exports=function(e,t,r){return t==t?i(e,t,r):n(e,o,r)}},454:e=>{e.exports=function(e){return e!=e}},501:e=>{e.exports=function(e,t,r){var n=-1,o=e.length;t<0&&(t=-t>o?0:o+t),(r=r>o?o:r)<0&&(r+=o),o=t>r?0:r-t>>>0,t>>>=0;for(var i=Array(o);++n<o;)i[n]=e[n+t];return i}},291:(e,t,r)=>{var n=r(650),o=r(111),i=r(142),a=r(187),s=n?n.prototype:void 0,c=s?s.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(i(t))return o(t,e)+"";if(a(t))return c?c.call(t):"";var r=t+"";return"0"==r&&1/t==-1/0?"-0":r}},403:(e,t,r)=>{var n=r(945),o=/^\s+/;e.exports=function(e){return e?e.slice(0,n(e)+1).replace(o,""):e}},931:(e,t,r)=>{var n=r(501);e.exports=function(e,t,r){var o=e.length;return r=void 0===r?o:r,!t&&r>=o?e:n(e,t,r)}},774:(e,t,r)=>{var n=r(478);e.exports=function(e,t){for(var r=e.length;r--&&n(t,e[r],0)>-1;);return r}},905:(e,t,r)=>{var n=r(478);e.exports=function(e,t){for(var r=-1,o=e.length;++r<o&&n(t,e[r],0)>-1;);return r}},967:(e,t,r)=>{var n="object"==typeof r.g&&r.g&&r.g.Object===Object&&r.g;e.exports=n},870:(e,t,r)=>{var n=r(650),o=Object.prototype,i=o.hasOwnProperty,a=o.toString,s=n?n.toStringTag:void 0;e.exports=function(e){var t=i.call(e,s),r=e[s];try{e[s]=void 0;var n=!0}catch(e){}var o=a.call(e);return n&&(t?e[s]=r:delete e[s]),o}},417:e=>{var t=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");e.exports=function(e){return t.test(e)}},5:e=>{var t=Object.prototype.toString;e.exports=function(e){return t.call(e)}},942:(e,t,r)=>{var n=r(967),o="object"==typeof self&&self&&self.Object===Object&&self,i=n||o||Function("return this")();e.exports=i},706:e=>{e.exports=function(e,t,r){for(var n=r-1,o=e.length;++n<o;)if(e[n]===t)return n;return-1}},237:(e,t,r)=>{var n=r(837),o=r(417),i=r(13);e.exports=function(e){return o(e)?i(e):n(e)}},945:e=>{var t=/\s/;e.exports=function(e){for(var r=e.length;r--&&t.test(e.charAt(r)););return r}},13:e=>{var t="\\ud800-\\udfff",r="["+t+"]",n="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",o="\\ud83c[\\udffb-\\udfff]",i="[^"+t+"]",a="(?:\\ud83c[\\udde6-\\uddff]){2}",s="[\\ud800-\\udbff][\\udc00-\\udfff]",c="(?:"+n+"|"+o+")?",u="[\\ufe0e\\ufe0f]?",p=u+c+"(?:\\u200d(?:"+[i,a,s].join("|")+")"+u+c+")*",h="(?:"+[i+n+"?",n,a,s,r].join("|")+")",f=RegExp(o+"(?="+o+")|"+h+p,"g");e.exports=function(e){return e.match(f)||[]}},142:e=>{var t=Array.isArray;e.exports=t},547:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},187:(e,t,r)=>{var n=r(379),o=r(547);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==n(e)}},243:(e,t,r)=>{var n=r(291);e.exports=function(e){return null==e?"":n(e)}},107:(e,t,r)=>{var n=r(291),o=r(403),i=r(931),a=r(774),s=r(905),c=r(237),u=r(243);e.exports=function(e,t,r){if((e=u(e))&&(r||void 0===t))return o(e);if(!e||!(t=n(t)))return e;var p=c(e),h=c(t),f=s(p,h),l=a(p,h)+1;return i(p,f,l).join("")}},426:(e,t,r)=>{var n=r(291),o=r(931),i=r(774),a=r(237),s=r(243),c=r(945);e.exports=function(e,t,r){if((e=s(e))&&(r||void 0===t))return e.slice(0,c(e)+1);if(!e||!(t=n(t)))return e;var u=a(e),p=i(u,a(t))+1;return o(u,0,p).join("")}},522:t=>{"use strict";t.exports=e},97:e=>{"use strict";e.exports=t}},n={};function o(e){var t=n[e];if(void 0!==t)return t.exports;var i=n[e]={exports:{}};return r[e](i,i.exports,o),i.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var i={};return(()=>{"use strict";o.d(i,{DecapCmsLibAuth:()=>v});var e=o(107),t=o.n(e),r=o(426),n=o.n(r);class a{constructor(e){this.err=e}toString(){return this.err&&this.err.message}}const s={github:{width:960,height:600},gitlab:{width:960,height:600},bitbucket:{width:960,height:500},email:{width:500,height:400}};var c=o(522),u=o(97);function p(){const e=(0,u.v4)();return window.sessionStorage.setItem("decap-cms-auth",JSON.stringify({nonce:e})),e}function h(e){const t=window.sessionStorage.getItem("decap-cms-auth"),r=t&&JSON.parse(t).nonce;return window.localStorage.removeItem("decap-cms-auth"),e===r}function f(){return"https:"!==document.location.protocol&&"localhost"!==document.location.hostname&&"127.0.0.1"!==document.location.hostname}const l=["access_token"];function d(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}const g="decap-cms-pkce-verifier-code";const v={NetlifyAuthenticator:class{constructor(e={}){this.site_id=e.site_id||null,this.base_url=n()(e.base_url,"/")||"https://api.netlify.com",this.auth_endpoint=t()(e.auth_endpoint,"/")||"auth"}handshakeCallback(e,t){const r=n=>{if(n.data==="authorizing:"+e.provider&&n.origin===this.base_url)return window.removeEventListener("message",r,!1),window.addEventListener("message",this.authorizeCallback(e,t),!1),this.authWindow.postMessage(n.data,n.origin)};return r}authorizeCallback(e,t){const r=n=>{if(n.origin===this.base_url){if(0===n.data.indexOf("authorization:"+e.provider+":success:")){const o=JSON.parse(n.data.match(new RegExp("^authorization:"+e.provider+":success:(.+)$"))[1]);window.removeEventListener("message",r,!1),this.authWindow.close(),t(null,o)}if(0===n.data.indexOf("authorization:"+e.provider+":error:")){const o=JSON.parse(n.data.match(new RegExp("^authorization:"+e.provider+":error:(.+)$"))[1]);window.removeEventListener("message",r,!1),this.authWindow.close(),t(new a(o))}}};return r}getSiteID(){if(this.site_id)return this.site_id;const e=document.location.host.split(":")[0];return"localhost"===e?"demo.decapcms.org":e}authenticate(e,t){const{provider:r}=e,n=this.getSiteID();if(!r)return t(new a({message:"You must specify a provider when calling netlify.authenticate"}));if(!n)return t(new a({message:"You must set a site_id with netlify.configure({site_id: 'your-site-id'}) to make authentication work from localhost"}));const o=s[r]||s.github,i=screen.width/2-o.width/2,c=screen.height/2-o.height/2;window.addEventListener("message",this.handshakeCallback(e,t),!1);let u=`${this.base_url}/${this.auth_endpoint}?provider=${e.provider}&site_id=${n}`;e.scope&&(u+="&scope="+e.scope),!0===e.login&&(u+="&login=true"),e.beta_invite&&(u+="&beta_invite="+e.beta_invite),e.invite_code&&(u+="&invite_code="+e.invite_code),this.authWindow=window.open(u,"Netlify Authorization",`width=${o.width}, height=${o.height}, top=${c}, left=${i}`),this.authWindow.focus()}refresh(e,t){const{provider:r,refresh_token:n}=e,o=this.getSiteID(),i=t||Promise.reject.bind(Promise);if(!r||!n)return i(new a({message:"You must specify a provider and refresh token when calling netlify.refresh"}));if(!o)return i(new a({message:"You must set a site_id with netlify.configure({site_id: 'your-site-id'}) to make token refresh work from localhost"}));const s=`${this.base_url}/${this.auth_endpoint}/refresh?provider=${r}&site_id=${o}&refresh_token=${n}`,c=fetch(s,{method:"POST",body:""}).then((e=>e.json()));if(!t)return c;c.then((e=>t(null,e))).catch(t)}},ImplicitAuthenticator:class{constructor(e={}){const r=n()(e.base_url,"/"),o=t()(e.auth_endpoint,"/");this.auth_url=`${r}/${o}`,this.appID=e.app_id,this.clearHash=e.clearHash}authenticate(e,t){if(f())return t(new Error("Cannot authenticate over insecure protocol!"));const r=new URL(this.auth_url);r.searchParams.set("client_id",this.appID),r.searchParams.set("redirect_uri",document.location.origin+document.location.pathname),r.searchParams.set("response_type","token"),r.searchParams.set("scope",e.scope),null!=e.prompt&&null!=e.prompt&&r.searchParams.set("prompt",e.prompt),null!=e.resource&&null!=e.resource&&r.searchParams.set("resource",e.resource);const n=JSON.stringify({auth_type:"implicit",nonce:p()});r.searchParams.set("state",n),document.location.assign(r.href)}completeAuth(e){const t=new URLSearchParams(document.location.hash.replace(/^#?\/?/,""));if(!t.has("access_token")&&!t.has("error"))return;this.clearHash();const r=(0,c.Map)(t.entries()),{nonce:n}=JSON.parse(r.get("state"));if(!h(n))return e(new Error("Invalid nonce"));if(r.has("error"))return e(new Error(`${r.get("error")}: ${r.get("error_description")}`));if(r.has("access_token")){const t=r.toJS(),{access_token:n}=t;e(null,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?d(Object(r),!0).forEach((function(t){var n,o,i,a;n=e,o=t,i=r[t],(o="symbol"==typeof(a=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(o))?a:String(a))in n?Object.defineProperty(n,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[o]=i})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({token:n},function(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}(t,l)))}}},PkceAuthenticator:class{constructor(e={}){const r=n()(e.base_url,"/"),o=t()(e.auth_endpoint,"/"),i=t()(e.auth_token_endpoint,"/");this.auth_url=`${r}/${o}`,this.auth_token_url=`${r}/${i}`,this.auth_token_endpoint_content_type=e.auth_token_endpoint_content_type,this.appID=e.app_id}async authenticate(e,t){if(f())return t(new Error("Cannot authenticate over insecure protocol!"));const r=new URL(this.auth_url);r.searchParams.set("client_id",this.appID),r.searchParams.set("redirect_uri",document.location.origin+document.location.pathname),r.searchParams.set("response_type","code"),r.searchParams.set("scope",e.scope);const n=JSON.stringify({auth_type:"pkce",nonce:p()});r.searchParams.set("state",n),r.searchParams.set("code_challenge_method","S256");const o=function(){const e=Array.from(window.crypto.getRandomValues(new Uint8Array(128))).map((e=>"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-."[e%64])).join("");return window.sessionStorage.setItem(g,e),e}(),i=await async function(e){const t=await async function(e){const t=(new TextEncoder).encode(e),r=await window.crypto.subtle.digest("SHA-256",t);return String.fromCharCode(...new Uint8Array(r))}(e);return btoa(t).split("=")[0].replace(/\+/g,"-").replace(/\//g,"_")}(o);r.searchParams.set("code_challenge",i),document.location.assign(r.href)}async completeAuth(e){const t=new URLSearchParams(document.location.search);if(window.history.replaceState(null,"",document.location.pathname),!t.has("code")&&!t.has("error"))return;let r;try{r=JSON.parse(t.get("state")).nonce}catch(e){r=JSON.parse(t.get("state").replace(/\\"/g,'"')).nonce}if(!h(r))return e(new Error("Invalid nonce"));if(t.has("error"))return e(new Error(`${t.get("error")}: ${t.get("error_description")}`));if(t.has("code")){const r=t.get("code"),n=new URL(this.auth_token_url),o={client_id:this.appID,code:r,grant_type:"authorization_code",redirect_uri:document.location.origin+document.location.pathname,code_verifier:window.sessionStorage.getItem(g)},i=await fetch(n.href,{method:"POST",body:this.auth_token_endpoint_content_type.startsWith("application/x-www-form-urlencoded")?new URLSearchParams(Object.entries(o)).toString():JSON.stringify(o),headers:{"Content-Type":this.auth_token_endpoint_content_type}}),a=await i.json();window.sessionStorage.removeItem(g),e(null,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach((function(t){var n,o,i,a;n=e,o=t,i=r[t],(o="symbol"==typeof(a=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var r=t.call(e,"string");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(o))?a:String(a))in n?Object.defineProperty(n,o,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[o]=i})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({token:a.access_token},a))}}}}})(),i.DecapCmsLibAuth})()));
//# sourceMappingURL=decap-cms-lib-auth.js.map